<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Call Debug Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #1a1a1a;
        color: white;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
      }

      .video-container {
        position: relative;
        width: 400px;
        height: 300px;
        background: #000;
        border: 2px solid #4ecdc4;
        border-radius: 8px;
        margin: 20px auto;
        overflow: hidden;
      }

      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
      }

      .controls {
        text-align: center;
        margin: 20px;
      }

      button {
        background: #4ecdc4;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
        font-size: 16px;
      }

      button:hover {
        background: #3bb3b1;
      }

      button:disabled {
        background: #666;
        cursor: not-allowed;
      }

      .status {
        margin: 20px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
      }

      .error {
        color: #ff6b6b;
      }

      .success {
        color: #4ecdc4;
      }

      .info {
        color: #ffd93d;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🎬 Video Call Debug Test</h1>
      <p>This tests the exact same camera initialization as the main app</p>

      <div class="video-container">
        <video id="localVideo" autoplay muted playsinline></video>
      </div>

      <div class="controls">
        <button id="startBtn" onclick="startVideo()">Start Camera</button>
        <button id="stopBtn" onclick="stopVideo()" disabled>Stop Camera</button>
        <button id="toggleVideo" onclick="toggleVideoTrack()" disabled>
          Toggle Video
        </button>
        <button id="toggleAudio" onclick="toggleAudioTrack()" disabled>
          Toggle Audio
        </button>
      </div>

      <div class="status" id="status">
        Click "Start Camera" to begin the test
      </div>

      <div class="status">
        <h3>Debug Information:</h3>
        <div id="debugInfo">
          Browser: <span id="browserInfo"></span><br />
          Camera support: <span id="cameraSupport"></span><br />
          Current stream: <span id="streamInfo">None</span><br />
          Video tracks: <span id="videoTracks">0</span><br />
          Audio tracks: <span id="audioTracks">0</span>
        </div>
      </div>
    </div>

    <script>
      let currentStream = null;
      const video = document.getElementById("localVideo");
      const status = document.getElementById("status");
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const toggleVideo = document.getElementById("toggleVideo");
      const toggleAudio = document.getElementById("toggleAudio");

      // Initialize debug info
      document.getElementById("browserInfo").textContent =
        navigator.userAgent.includes("Chrome")
          ? "Chrome"
          : navigator.userAgent.includes("Firefox")
          ? "Firefox"
          : navigator.userAgent.includes("Safari")
          ? "Safari"
          : "Unknown";

      document.getElementById("cameraSupport").textContent =
        navigator.mediaDevices && navigator.mediaDevices.getUserMedia
          ? "Yes"
          : "No";

      function updateStatus(message, type = "info") {
        status.innerHTML = `<span class="${type}">${message}</span>`;
        console.log(`[${type.toUpperCase()}] ${message}`);
      }

      function updateDebugInfo() {
        if (currentStream) {
          document.getElementById("streamInfo").textContent = "Active";
          document.getElementById("videoTracks").textContent =
            currentStream.getVideoTracks().length;
          document.getElementById("audioTracks").textContent =
            currentStream.getAudioTracks().length;

          const videoTrack = currentStream.getVideoTracks()[0];
          const audioTrack = currentStream.getAudioTracks()[0];

          if (videoTrack) {
            console.log(
              "Video track state:",
              videoTrack.readyState,
              "enabled:",
              videoTrack.enabled
            );
          }
          if (audioTrack) {
            console.log(
              "Audio track state:",
              audioTrack.readyState,
              "enabled:",
              audioTrack.enabled
            );
          }
        } else {
          document.getElementById("streamInfo").textContent = "None";
          document.getElementById("videoTracks").textContent = "0";
          document.getElementById("audioTracks").textContent = "0";
        }
      }

      async function startVideo() {
        try {
          updateStatus("Requesting camera access...", "info");
          startBtn.disabled = true;

          // Use exact same constraints as the main app
          currentStream = await navigator.mediaDevices.getUserMedia({
            video: {
              width: { ideal: 1280, min: 640 },
              height: { ideal: 720, min: 480 },
              frameRate: { ideal: 30, min: 15 },
              facingMode: "user",
            },
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true,
              sampleRate: 44100,
            },
          });

          console.log("Stream obtained:", currentStream);
          console.log("Stream active:", currentStream.active);
          console.log("Video tracks:", currentStream.getVideoTracks().length);
          console.log("Audio tracks:", currentStream.getAudioTracks().length);

          video.srcObject = currentStream;

          video.onloadedmetadata = () => {
            console.log("Video metadata loaded");
            video
              .play()
              .then(() => {
                updateStatus("✅ Camera started successfully!", "success");
                stopBtn.disabled = false;
                toggleVideo.disabled = false;
                toggleAudio.disabled = false;
                updateDebugInfo();
              })
              .catch((e) => {
                updateStatus("❌ Error playing video: " + e.message, "error");
              });
          };

          video.onplay = () => {
            console.log("Video started playing");
          };

          video.onpause = () => {
            console.log("Video paused");
          };
        } catch (error) {
          console.error("Error accessing camera:", error);
          updateStatus("❌ Error: " + error.message, "error");
          startBtn.disabled = false;

          if (error.name === "NotAllowedError") {
            updateStatus(
              "❌ Camera permission denied. Please allow camera access and try again.",
              "error"
            );
          } else if (error.name === "NotFoundError") {
            updateStatus("❌ No camera found.", "error");
          }
        }
      }

      function stopVideo() {
        if (currentStream) {
          currentStream.getTracks().forEach((track) => {
            console.log("Stopping track:", track.kind);
            track.stop();
          });
          video.srcObject = null;
          currentStream = null;

          updateStatus("Camera stopped.", "info");
          startBtn.disabled = false;
          stopBtn.disabled = true;
          toggleVideo.disabled = true;
          toggleAudio.disabled = true;
          updateDebugInfo();
        }
      }

      function toggleVideoTrack() {
        if (currentStream) {
          const videoTrack = currentStream.getVideoTracks()[0];
          if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            updateStatus(
              videoTrack.enabled ? "📹 Video enabled" : "📷 Video disabled",
              "info"
            );
            updateDebugInfo();
          }
        }
      }

      function toggleAudioTrack() {
        if (currentStream) {
          const audioTrack = currentStream.getAudioTracks()[0];
          if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            updateStatus(
              audioTrack.enabled ? "🎤 Audio enabled" : "🔇 Audio muted",
              "info"
            );
            updateDebugInfo();
          }
        }
      }

      // Cleanup on page unload
      window.addEventListener("beforeunload", () => {
        if (currentStream) {
          currentStream.getTracks().forEach((track) => track.stop());
        }
      });
    </script>
  </body>
</html>
